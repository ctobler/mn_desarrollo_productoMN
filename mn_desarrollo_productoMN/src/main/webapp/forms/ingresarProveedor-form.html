<center>
	<h2><strong>Desarrollo Producto</strong></h2>
	<h3><p>Ingresar proveedores</p></h3>
</center>

<form role="form" name="form" class="form-horizontal" >

  <script cam-script type="text/form-script">
	var dataProductoMN = $scope.dataProductoMN={
		proveedoresMN : [],
		total : 0,
		moneda : 'USD'
	};
	var subtotal = $scope.subtotal = {};
		
	//FUNCION PARA INICIAR EL TOTAL
	$scope.calcularTotal = function(tasaCambio) {
		var totalDolares= $scope.getSubTotalDolares();
		var totalPesos= $scope.getSubTotalPesos();
		var total= $scope.convertirUSD(totalPesos,tasaCambio) + totalDolares;
		$scope.dataProductoMN.total= total;
		return total;
	}
	// funcion scope que agrega proveedores
	$scope.agregarProveedor= function() {
		dataProductoMN.proveedoresMN.push({});
		$scope.errorProveedoresVacio= false;
	};
	
	//funcion para quitar proveedores
	$scope.quitarProveedor = function (x) {
        dataProductoMN.proveedoresMN.splice(x, 1);
    } 
	//funcion para calcular sub-total en USD 
	$scope.getSubTotalDolares = function() {
		var subTotal= 0;
		for(var i=0; i < $scope.dataProductoMN.proveedoresMN.length; i++)
		{
			var prov= $scope.dataProductoMN.proveedoresMN[i];
			var moneda= $scope.dataProductoMN.proveedoresMN[i].moneda;
			if(moneda == "USD")
			{	
				if ( isNaN(prov.precio) )
					prov.precio= 0;
				else	
					subTotal += prov.precio;
			}
			
		}
		return subTotal;
	}
	//funcion para calcular sub-total en Pesos 
	$scope.getSubTotalPesos = function() {
		var subTotal= 0;
		for(var i=0; i < $scope.dataProductoMN.proveedoresMN.length; i++)
		{
			var prov= $scope.dataProductoMN.proveedoresMN[i];
			var moneda= $scope.dataProductoMN.proveedoresMN[i].moneda;
			if(moneda == "$U")
			{	
				if ( isNaN(prov.precio) )
					prov.precio=0;
				else
					subTotal += prov.precio;
			}
			
		}
		return subTotal;
	}
	//bandera para indicar si hay existe algun precio de proveedor en pesos
	$scope.existePesos = function() {
		var existePesos= false;
		for(var i=0; i < $scope.dataProductoMN.proveedoresMN.length; i++)
		{
			var prov= $scope.dataProductoMN.proveedoresMN[i];
			var moneda= $scope.dataProductoMN.proveedoresMN[i].moneda;
			if(moneda == "$U")
			{	
				existePesos = true;
			}
			
		}
		return existePesos;
	}
	$scope.convertirUSD= function(subTotal,tasaCambio){
		var dolares=0;
		if( isNaN(tasaCambio) )
		{
			dolares=0;
		}
		else if(tasaCambio <= 0)
		{
			dolares=0;
		}
		else if(subTotal > 0)
		{
			dolares= (subTotal / tasaCambio);
		}
		return dolares;
	}	
	//funcion para quitar mensaje de error en cantidad
	$scope.limpiarMensaje= function(){
		if(dataProductoMN.cantidad > 0)
			$scope.errorCantidadVaciaONula= false;
	};
	
	$scope.monedas=["USD","$U"]
	
	$scope.impuestos=["IVA INC.", "SIN IVA"]
	
	//enganchar con el ciclo de vida del formulario camunda SDK 
	camForm.on('form-loaded',function() {
		
		//declarar variable 'dataProductoMN' incluyendo metadata para serializacion
		camForm.variableManager.createVariable({
			name: 'dataProductoMN',
			type: 'Object',
			value: dataProductoMN,
			valueInfo: {
			  //indicar que el objeto es serializado como json
			  serializationDataFormat: 'application/json',
			  //proveer nombre de la clase java a mapear
			  objectTypeName: 'org.camunda.bpm.menini_nicola.mn_desarrollo_productoMN.modelo.ProductoMN'
			}
		});
	});
	//para que funcione el agregar proveedores dinamicamente
	camForm.on('submit', function(){
		angular.forEach(dataProductoMN.proveedoresMN, function(prvdr) {
			delete prvdr.$$hashKey;
		});
	});
	//traer variable 'pago' ingresada en el start-form	
	camForm.on('form-loaded', function() {
  	// tell the form SDK to fetch the json variable named 'pago'
  		camForm.variableManager.fetchVariable('pago');
	});
	camForm.on('variables-fetched', function() {
  	// trabajar con valor de variable 'pago' (atar su valor a AngularJS $scope)
  		$scope.pago = camForm.variableManager.variableValue('pago');
	});
	//verificar ingreso de datos obligatorios antes de enviar formulario al servidor
	camForm.on('submit', function(evt) {
      // manejar submit
      // evitar envio de formulario si hay errores:
	  
	  //verificar que exista al menos un proveedor
	  if(dataProductoMN.proveedoresMN.length == 0)
	  {
      	evt.submitPrevented = true;
		$scope.errorProveedoresVacio= true; 
      }
	  else
	  {
		evt.submitPrevented = false;
		$scope.errorProveedoresVacio= false;
	  }
	  //verificar que la cantidad de productos sea mayor a cero
	  if(dataProductoMN.cantidad < 1)
	  {
	  	evt.submitPrevented = true;	
		$scope.errorCantidadVaciaONula= true;
	  }
	  else 
	  {
		evt.submitPrevented = false;
		$scope.errorCantidadVaciaONula= false;
	  }
    });
  </script>
  		
  	  <div class="control-group">
  		<label class="control-label">Seña recibida: {{pago.moneda +" "+ pago.senia}}</label>
	  </div>
	  
	  <label for="categoria" class="control-label">Cotización *</label>
      <select cam-variable-name="cotizacion"
            cam-variable-type="String"
            cam-choices="PRESUPUESTOS_APROBADOS"
            ng-model="dataProductoMN.senia"
            required
            class="form-control">
	  </select>
	  
	  <label for="TRABAJO_REALIZADO" class="control-label">Trabajo Realizado *</label>
	  <div class="control-group">
      	<div class="controls">
   	  		<input 	id="idTrabajoRealizado"
   					class="form-control"
   					type="text"
   					required 
   					ng-model="dataProductoMN.trabajoRealizado"
    				name="TRABAJO_REALIZADO">
    		<!--validar ingreso de trabajo realizado-->
      		<p>
      			<span style="color:red" ng-show="form.TRABAJO_REALIZADO.$dirty && form.TRABAJO_REALIZADO.$invalid">
  					<span ng-show="form.TRABAJO_REALIZADO.$error.required">trabajo realizado es obligatorio</span>
  				</span>
      		</p>   	
    	</div>
      </div>
	  <div class="row">
	  	<div class="col-xs-2">
 			<div class="control-group">
 				<div class="controls">
 					<label for="CANTIDAD" class="control-label">Unidades *</label>
 					<input 	id="idCantidad"
   							class="form-control"
   							type="number" 
   							required
   							ng-model="dataProductoMN.cantidad"
    	   					name="CANTIDAD"
    	   					ng-click="limpiarMensaje()">
    	   				
    	   			<!--validar ingreso de cantidad-->
      				<p>
      					<span style="color:red" ng-show="form.CANTIDAD.$dirty && form.CANTIDAD.$invalid">
  							<span ng-show="form.CANTIDAD.$error.required">cantidad es obligatoria</span>
  						</span>
      				</p>
 				</div>
 			</div>
 		</div>
      	<div class="col-xs-10">
 			<div class="control-group">
 				<div class="controls">
	  				<label for="NOMBRE_PRODUCTO" class="control-label">Nombre del Producto *</label>
	  				<input 	id="idNombre"
   							class="form-control"
   							type="text" 
   							required
   							ng-model="dataProductoMN.nombre"
    						name="NOMBRE_PRODUCTO">
    				
    				<!--validar ingreso de nombre de producto-->
      				<p>
      					<span style="color:red" ng-show="form.NOMBRE_PRODUCTO.$dirty && form.NOMBRE_PRODUCTO.$invalid">
  							<span ng-show="form.NOMBRE_PRODUCTO.$error.required">nombre de producto es obligatorio</span>
  						</span>
      				</p>	
    			</div>
      		</div>
       	</div>
      </div>
            
	  <br>
		
	  <div class="control-group" align="center">
      	<button ng-click="agregarProveedor()"> Nuevo Proveedor</button>
      </div>
	  
	  <!-- agregar proveedor -->
	  
	  <div ng-repeat="prov in dataProductoMN.proveedoresMN">
	 	<hr>	
	   	<div class="control-group">
       		<label for="PROVEEDOR" class="control-label">Tipo de Proveedor *</label>
      		<div class="controls">
      			<input  id="idTipoProveedor"
      				    class="form-control" 
      		   			type="text"
      		   			required      		 
      		  			ng-model="prov.tipoProveedor"
      		   			name="PROVEEDOR" 
               			maxlength=100>
         		   	   		
            <!--validar ingreso de proveedor-->
      			<p>
      				<span style="color:red" ng-show="form.PROVEEDOR.$dirty && form.PROVEEDOR.$invalid">
  						<span ng-show="form.PROVEEDOR.$error.required">tipo proveedor es obligatorio</span>
  					</span>
      			</p>   	   		
            </div>
        </div>
            
		<label  class="control-label">Precio *</label> 
       	<div class="row">
        	<div class="col-xs-2">
 				<div class="control-group">
 					<div class="controls">
            			<select ng-init="prov.moneda = monedas[0]"
            					ng-model="prov.moneda" 
            					ng-options="x for x in monedas"
            					required>
						</select>
					</div>
				</div>
			</div>
            <div class="col-xs-8">
        		<div class="control-group">
<!--       		<label  for="PRECIO" class="control-label">Precio *</label> -->
   					<div class="controls">
   						<input 	id="idPrecio"
   								class="form-control"
   								type="number" 
   								required
   								ng-model="prov.precio"
    	   						name="PRECIO">
  	
    	   					<!--validar ingreso de precio-->
      					<p>
      						<span style="color:red" ng-show="form.PRECIO.$dirty && form.PRECIO.$invalid">
  								<span ng-show="form.PRECIO.$error.required">precio proveedor es obligatorio</span>
  							</span>
      					</p>
      				</div>
      			</div>
      		</div>
      			
      		<div class="col-xs-2">
      			<div class="control-group">
      				<div class="controls">
            			<select ng-init="prov.ivaProveedor = impuestos[0]"
            					ng-model="prov.ivaProveedor" 
            					ng-options="x for x in impuestos"
            					required>
						</select>
					</div>
				</div>
      		</div>
      	</div>
     		
		<div class="control-group">
      		<label for="DETALLES" class="control-label">Detalles</label>
      			<div class="controls">
   					<input 	id="idDetalles"
   							class="form-control"
   							type="text" 
   							ng-model="prov.detalles"
    						name="DETALLES">
    			</div>
      	</div>
      	<br>
      	<div class="control-group" style="float:left;">
      		<button ng-click="quitarProveedor($index)">&times; Quitar Proveedor</button>
      	</div>
      </div>
            
      <div ng-if="errorProveedoresVacio">
		<p style="color:red;font-weight:bold">debe ingresar al menos un proveedor</p>
	  </div>
      <div ng-if="errorCantidadVaciaONula">
		<p style="color:red;font-weight:bold">las unidades deben ser mayor a 0</p>
	  </div>
	  
	  <hr>
	         	
      <div class="control-group" ng-show="existePesos()">
      	<div class="controls">
      		<label class="control-label">Taza de cambio *: </label>
      		<input 	id="idTazaCambio"
   					class="form-control"
   					type="number" 
   					ng-model="tazaCambio"
    	   			name="TAZA_CAMBIO"
    	   			ng-init= "0">
    					
    	   			<!--validar ingreso de precio-->
      				<p>
      					<span style="color:red" ng-show="form.TAZA_CAMBIO.$dirty && form.TAZA_CAMBIO.$invalid">
  							<span ng-show="form.TAZA_CAMBIO.$error.required">la taza de cambio es obligatorio</span>
  						</span>					
      				</p>
      	</div>
      </div>
      
      <hr>
     	
     <div class="control-group">
      	<div class="control-group">
      		<div class="controls">
	  			<label class="control-label">Sub-total($U): {{getSubTotalPesos()}}</label>
	  		</div>
	  	</div>
      	<div class="control-group">
      		<div class="controls">
	  			<label class="control-label">Sub-total(USD): {{getSubTotalDolares()}}</label>
	  		</div>
	  	</div>
      	<div class="controls">
	    	<label class="control-label">TOTAL (USD)</label>
      	</div>	      			
      	
<!--       	<p>{{calcularTotal(tazaCambio)}}</p> -->
      	
<!--       	<input ng-value= "getSubTotalDolares() + convertirUSD(getSubTotalPesos(),tazaCambio)"  	 -->
<!--       		   readonly>  -->
		
		<input ng-value= "calcularTotal(tazaCambio)"  	
      		   readonly> 
					      		      		   	   
      	<select ng-init="dataProductoMN.ivaProducto = impuestos[1]"
        		ng-model="dataProductoMN.ivaProducto" 
        		ng-options="x for x in impuestos"
        		required>
		</select>
		<br>
		<div align="left">
			<label for="descartarPresupuesto">(cancelar ?)</label>
			<br>
	    	<input type="checkbox"
	        	   cam-variable-name="cancelarProduccion"
	           	   cam-variable-type="Boolean"
	           	   name="cancelarProduccion"
	           	   class="form-control" />
		</div>
		
<!-- 		<input ng-value="calcularTotal(tazaCambio)" readonly> -->
<!-- 		<p>{{dataProductoMN.total}}</p> -->
	
      </div>
</form>